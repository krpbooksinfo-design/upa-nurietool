<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ウパぬり絵ツール</title>
<style>
body{margin:0;font-family:sans-serif;background:#f5f5f5}
#app{display:flex;height:100vh;overflow:hidden}
#panel{width:130px;background:#fff;border-right:1px solid #ccc;padding:6px;box-sizing:border-box}
#panel h1{font-size:12px;text-align:center;margin:4px 0 8px}
button,input[type=color]{width:100%;margin-bottom:6px;font-size:13px}
.palette{display:grid;grid-template-columns:repeat(2,1fr);gap:4px;margin-bottom:6px}
.colorBtn{width:100%;height:24px;border:none}
#modeDisplay{font-size:12px;text-align:center;margin-bottom:6px;font-weight:bold}
#canvasWrap{flex:1;display:flex;justify-content:center;align-items:center}
canvas{background:#fff;border:1px solid #ccc;touch-action:none}
.active{background:#ddd}
</style>
</head>
<body>
<div id="app">
  <div id="panel">
    <h1>ウパぬり絵ツール</h1>
    <input type="file" id="imgLoader" accept="image/*">
    <div class="palette" id="palette"></div>
    <input type="color" id="freeColor">
    <label>ふとさ</label>
    <input type="range" id="size" min="1" max="20" value="4">
    <div id="modeDisplay">ペン</div>
    <button id="penBtn" class="active">ペン</button>
    <button id="bucketBtn">バケツ</button>
    <button id="undoBtn">ひとつまえ</button>
    <button id="clearBtn">クリア</button>
    <button id="saveBtn">PNG保存</button>
  </div>
  <div id="canvasWrap">
    <canvas id="canvas" width="360" height="640"></canvas>
  </div>
</div>
<script>
const canvas=document.getElementById('canvas')
const ctx=canvas.getContext('2d',{willReadFrequently:true})
let drawing=false,mode='pen',color='#ff0000',lastX,lastY
let history=[]
const modeDisplay=document.getElementById('modeDisplay')

function saveHistory(){if(history.length>20)history.shift();history.push(ctx.getImageData(0,0,canvas.width,canvas.height))}
function restoreHistory(){if(history.length){ctx.putImageData(history.pop(),0,0)}}

const colors=['#000000','#ff0000','#00aa00','#0000ff','#ffff00','#ff00ff','#00ffff','#ffffff','#888888','#ff8800']
const pal=document.getElementById('palette')
colors.forEach(c=>{const b=document.createElement('button');b.className='colorBtn';b.style.background=c;b.onclick=()=>color=c;pal.appendChild(b)})

const freeColor=document.getElementById('freeColor')
freeColor.oninput=e=>color=e.target.value

function getPos(e){const r=canvas.getBoundingClientRect();const p=e.touches?e.touches[0]:e;return {x:p.clientX-r.left,y:p.clientY-r.top}}

canvas.addEventListener('pointerdown',e=>{
  const p=getPos(e)
  if(mode==='pen'){
    saveHistory();drawing=true;ctx.beginPath();ctx.moveTo(p.x,p.y)}
  else{saveHistory();floodFill(Math.floor(p.x),Math.floor(p.y))}
})
canvas.addEventListener('pointermove',e=>{if(!drawing||mode!=='pen')return;const p=getPos(e);ctx.strokeStyle=color;ctx.lineWidth=size.value;ctx.lineTo(p.x,p.y);ctx.stroke();lastX=p.x;lastY=p.y})
canvas.addEventListener('pointerup',()=>drawing=false)
canvas.addEventListener('pointerleave',()=>drawing=false)

penBtn.onclick=()=>{mode='pen';modeDisplay.textContent='ペン';penBtn.classList.add('active');bucketBtn.classList.remove('active')}
bucketBtn.onclick=()=>{mode='bucket';modeDisplay.textContent='バケツ';bucketBtn.classList.add('active');penBtn.classList.remove('active')}
undoBtn.onclick=restoreHistory
clearBtn.onclick=()=>{if(confirm('クリアしますか？')){saveHistory();ctx.clearRect(0,0,canvas.width,canvas.height)}}
size.oninput=e=>ctx.lineWidth=e.target.value

imgLoader.onchange=e=>{const file=e.target.files[0];if(!file)return;const img=new Image();img.onload=()=>{const w=Math.min(img.width,1024);const h=Math.min(img.height,1024);canvas.width=w;canvas.height=h;ctx.drawImage(img,0,0,w,h);history=[]};img.src=URL.createObjectURL(file)}

function hexToRgb(hex){const n=parseInt(hex.slice(1),16);return{r:(n>>16)&255,g:(n>>8)&255,b:n&255,a:255}}
function floodFill(x,y){const img=ctx.getImageData(0,0,canvas.width,canvas.height);const d=img.data,w=canvas.width,h=canvas.height;const i=(y*w+x)*4;const t={r:d[i],g:d[i+1],b:d[i+2],a:d[i+3]};const f=hexToRgb(color);const tol=30;if(t.r===f.r&&t.g===f.g&&t.b===f.b)return;const s=[[x,y]];while(s.length){const [cx,cy]=s.pop();if(cx<0||cy<0||cx>=w||cy>=h)continue;const j=(cy*w+cx)*4;if(Math.abs(d[j]-t.r)<=tol&&Math.abs(d[j+1]-t.g)<=tol&&Math.abs(d[j+2]-t.b)<=tol&&d[j+3]===t.a){d[j]=f.r;d[j+1]=f.g;d[j+2]=f.b;d[j+3]=255;s.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1])}}ctx.putImageData(img,0,0)}

saveBtn.onclick=()=>{
  const link=document.createElement('a');
  link.download='nuri.png';
  link.href=canvas.toDataURL('image/png');
  link.click();
}
</script>
</body>
</html>
